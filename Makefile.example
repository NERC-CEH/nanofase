FC = gfortran
FCFLAGS = -O1 -fcheck=all -fbackslash -Wall -Wno-unused-dummy-argument -fopenmp
DEBUGFLAGS = -g -ffpe-trap=zero,invalid,overflow,underflow
EXEC_FILE = main
EXEC_PATH = ./bin/
NETCDF = `nf-config --fflags --flibs`
CONFIG_PATH = ./config/
CONFIG_FILE = thames.nml
GIT_HASH = `git rev-parse HEAD`
COMPILE_TIME = `date -u +'%Y-%m-%d %H:%M:%S UTC'`
GIT_BRANCH = `git rev-parse --abbrev-ref HEAD`
COMP_META = $(COMPILE_TIME) $(GIT_HASH) $(GIT_BRANCH)

OBJ = vendor/feh/src/ErrorInstance.o \
	vendor/feh/src/Result.o \
	vendor/feh/src/ErrorHandler.o \
	vendor/feh/src/ErrorCriteria.o \
	vendor/mo_netcdf/src/mo_types.o \
	vendor/mo_netcdf/src/mo_netcdf.o \
	vendor/datetime-fortran/mod_timedelta.o \
	vendor/datetime-fortran/mod_strftime.o \
	vendor/datetime-fortran/mod_constants.o \
	vendor/datetime-fortran/mod_datetime.o \
	vendor/datetime-fortran/mod_clock.o \
	vendor/datetime-fortran/datetime.o \
	src/mod_strptime.o \
	src/Globals.o \
	src/UtilModule.o \
	src/Logger/classLogger.o \
	src/DataInterfacer/classDataInterfacer.o \
	src/classDatabase.o \
	src/Biota/spcBiota.o \
	src/Biota/classBiota1.o \
	src/Reactor/spcReactor.o \
	src/Reactor/classReactor1.o \
	src/BedSedimentLayer/classFineSediment1.o \
	src/BedSedimentLayer/spcBedSedimentLayer.o \
	src/BedSedimentLayer/classBedSedimentLayer1.o \
	src/BedSediment/spcBedSediment.o \
	src/BedSediment/classBedSediment1.o \
	src/Source/classDiffuseSource2.o \
	src/Source/classPointSource.o \
	src/WaterBody/spcWaterBody.o \
	src/WaterBody/spcReach.o \
	src/classRiverReach.o \
	src/classEstuaryReach.o \
	src/classSampleSite.o \
	src/Soil/spcSoilLayer.o \
	src/Soil/classSoilLayer1.o \
	src/Soil/spcSoilProfile.o \
	src/Soil/classSoilProfile1.o \
	src/GridCell/classCrop.o \
	src/GridCell/spcGridCell.o \
	src/GridCell/classGridCell2.o \
	src/Environment/spcEnvironment.o \
	src/Environment/classEnvironment1.o \
	src/main.o 

OBJECTS = $(notdir $(OBJ))

VPATH = vendor/feh/src \
	vendor/mo_netcdf/src \
	vendor/datetime-fortran/src/lib \
	src \
	src/Logger \
	src/DataInterfacer \
	src/Biota \
	src/Reactor \
	src/BedSedimentLayer \
	src/BedSediment \
	src/Source \
	src/WaterBody \
	src/Soil \
	src/GridCell \
	src/Environment

# 	-O0 flag would be preferable but a GFortran bug causes character
# 	length mismatch in array constructor errors with allocatable
# 	character variables, even when they're the correct length. See
# 	https://gcc.gnu.org/bugzilla/show_bug.cgi?id=70231 and
# 	https://stackoverflow.com/questions/44385909/adding-to-an-array-of-characters-in-fortran.
# 	Solution is to use -O1 or higher.
$(EXEC_FILE): $(OBJECTS)
	$(FC) $(FCFLAGS) $(DEBUGFLAGS) -o $(EXEC_PATH)$@ $^ $(NETCDF)
	echo $(COMP_META) > $(EXEC_PATH)comp_meta
%.o: %.f90
	$(FC) -c $(FCFLAGS) $(DEBUGFLAGS) $< $(NETCDF)
test:
	$(foreach obj,$(OBJECTS),$(call make-test,$(obj)))
run:
	$(EXEC_PATH)$(EXEC_FILE) $(CONFIG_PATH)$(CONFIG_FILE)
debug:
	gdb --args $(EXEC_PATH)$(EXEC_FILE) $(CONFIG_PATH)$(CONFIG_FILE)
clean:
	rm -f *.mod *.o *.stackdump Debug/*.*

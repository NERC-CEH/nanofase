FC = gfortran
FCFLAGS = -O1 -fcheck=all -fbackslash -Wall -Wno-unused-dummy-argument
EXEC_FILE = main
EXEC_PATH = ./bin/
CONFIG_PATH = ./
NETCDF = `nf-config --fflags --flibs`

OBJ = vendor/feh/src/ErrorInstance.o \
	vendor/feh/src/Result.o \
	vendor/feh/src/ErrorHandler.o \
	vendor/feh/src/ErrorCriteria.o \
	vendor/mo_netcdf/src/mo_types.o \
	vendor/mo_netcdf/src/mo_netcdf.o \
	src/Globals.o \
	src/UtilModule.o \
	src/DataInterfacer/classDataInterfacer.o \
	src/Biota/spcBiota.o \
	src/Biota/classBiota1.o \
	src/Biota/classBiota2.o \
	src/Reactor/spcReactor.o \
	src/Reactor/classReactor1.o \
	src/BedSedimentLayer/classFineSediment1.o \
	src/BedSedimentLayer/spcBedSedimentLayer.o \
	src/BedSedimentLayer/classBedSedimentLayer1.o \
	src/BedSediment/spcBedSediment.o \
	src/BedSediment/classBedSediment1.o \
	src/Source/classDiffuseSource.o \
	src/Source/classPointSource.o \
	src/RiverReach/spcRiverReach.o \
	src/RiverReach/classRiverReach1.o \
	src/Estuary/spcEstuaryReach.o \
	src/Estuary/classEstuaryReach1.o \
	src/Soil/spcSoilLayer.o \
	src/Soil/classSoilLayer1.o \
	src/Soil/spcSoilProfile.o \
	src/Soil/classSoilProfile1.o \
	src/GridCell/classCrop.o \
	src/GridCell/spcGridCell.o \
	src/GridCell/classGridCell1.o \
	src/Environment/spcEnvironment.o \
	src/Environment/classEnvironment1.o \
	src/main.o 

OBJECTS = $(notdir $(OBJ))

VPATH = vendor/feh/src \
	vendor/mo_netcdf/src \
	src \
	src/DataInterfacer \
	src/Biota \
	src/Reactor \
	src/BedSedimentLayer \
	src/BedSediment \
	src/Source \
	src/RiverReach \
	src/Estuary \
	src/Soil \
	src/GridCell \
	src/Environment

# define make-goal
# $(notdir $(1)).o: $(1).f90:
# 	$(FC) -c $(FCFLAGS) $$< $(NETCDF)
# endef

# define make-test
# 	@echo $1
# endef

# 	-O0 flag would be preferable but a GFortran bug causes character
# 	length mismatch in array constructor errors with allocatable
# 	character variables, even when they're the correct length. See
# 	https://gcc.gnu.org/bugzilla/show_bug.cgi?id=70231 and
# 	https://stackoverflow.com/questions/44385909/adding-to-an-array-of-characters-in-fortran.
# 	Solution is to use -O1 or higher.
$(EXEC_FILE): $(OBJECTS)
	$(FC) $(FCFLAGS) -o $(EXEC_PATH)$@ $^ $(NETCDF)
%.o: %.f90
	$(FC) -c $(FCFLAGS) $< $(NETCDF)
test:
	$(foreach obj,$(OBJECTS),$(call make-test,$(obj)))
run:
	$(EXEC_PATH)$(EXEC_FILE)
j2n:
	python vendor/json2netcdf/json2netcdf.py data/data.json data/data.nc
j2n-compact:
	python vendor/json2netcdf/json2netcdf-compact.py data/data-compact.json data/data-compact.nc
clean:
	rm -f *.mod *.o *.stackdump Debug/*.*

$(foreach obj,$(OBJECTS),$(eval $(call make-goal,$(obj))))